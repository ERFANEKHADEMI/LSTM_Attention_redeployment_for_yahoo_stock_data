trigger:
- main

variables:
  subscriptionId: '38ca6696-5c82-4571-b2af-bf3f256cf663'
  resourceGroupName: 'rocket_test'

pool:
  vmImage: ubuntu-latest

steps:
- task: AzureResourceManagerTemplateDeployment@3
  displayName: 'Deploy Azure Blob Storage'
  inputs:
    deploymentScope: 'Resource Group'
    azureResourceManagerConnection: 'Azure subscription 1 ($(subscriptionId))'
    subscriptionId: $(subscriptionId)
    action: 'Create Or Update Resource Group'
    resourceGroupName: $(resourceGroupName)
    location: 'East US 2'
    templateLocation: 'Linked artifact'
    csmFile: '$(Build.SourcesDirectory)/arm_templates/blob_storage/blob_storage_template.json'
    csmParametersFile: '$(Build.SourcesDirectory)/arm_templates/blob_storage/blob_storage_parameters.json'
    deploymentMode: 'Incremental'

- task: AzureResourceManagerTemplateDeployment@3
  displayName: 'Deploy Azure ML Studio Workspace and dependencies'
  inputs:
    deploymentScope: 'Resource Group'
    azureResourceManagerConnection: 'Azure subscription 1 ($(subscriptionId))'
    subscriptionId: $(subscriptionId)
    action: 'Create Or Update Resource Group'
    resourceGroupName: $(resourceGroupName)
    location: 'East US 2'
    templateLocation: 'Linked artifact'
    csmFile: '$(Build.SourcesDirectory)/arm_templates/mlstudio/azureml_template.json'
    csmParametersFile: '$(Build.SourcesDirectory)/arm_templates/mlstudio/azureml_parameters.json'
    deploymentMode: 'Incremental'

- task: AzureResourceManagerTemplateDeployment@3
  displayName: 'Deploy Kafka with its infrastructure'
  inputs:
    deploymentScope: 'Resource Group'
    azureResourceManagerConnection: 'Azure subscription 1 ($(subscriptionId))'
    subscriptionId: $(subscriptionId)
    action: 'Create Or Update Resource Group'
    resourceGroupName: $(resourceGroupName)
    location: 'East US 2'
    templateLocation: 'Linked artifact'
    csmFile: '$(Build.SourcesDirectory)/arm_templates/kafka/kafka_infra_template.json'
    csmParametersFile: '$(Build.SourcesDirectory)/arm_templates/kafka/kafka_infra_parameters.json'
    deploymentMode: 'Incremental'

- task: AzureResourceManagerTemplateDeployment@3
  displayName: 'Deploy Airbyte with its infrastructure'
  inputs:
    deploymentScope: 'Resource Group'
    azureResourceManagerConnection: 'Azure subscription 1 ($(subscriptionId))'
    subscriptionId: $(subscriptionId)
    action: 'Create Or Update Resource Group'
    resourceGroupName: $(resourceGroupName)
    location: 'East US 2'
    templateLocation: 'Linked artifact'
    csmFile: '$(Build.SourcesDirectory)/arm_templates/airbyte/airbyte_infra_template.json'
    csmParametersFile: '$(Build.SourcesDirectory)/arm_templates/airbyte/airbyte_infra_parameters.json'
    deploymentMode: 'Incremental'

- task: AzureResourceManagerTemplateDeployment@3
  displayName: 'Deploy MLflow with its infrastructure'
  inputs:
    deploymentScope: 'Resource Group'
    azureResourceManagerConnection: 'Azure subscription 1 ($(subscriptionId))'
    subscriptionId: $(subscriptionId)
    action: 'Create Or Update Resource Group'
    resourceGroupName: $(resourceGroupName)
    location: 'East US 2'
    templateLocation: 'Linked artifact'
    csmFile: '$(Build.SourcesDirectory)/arm_templates/mlflow/mlflow_infra_template.json'
    csmParametersFile: '$(Build.SourcesDirectory)/arm_templates/mlflow/mlflow_infra_parameters.json'
    deploymentMode: 'Incremental'

- task: AzureResourceManagerTemplateDeployment@3
  displayName: 'Deploy Airflow with its infrastructure'
  inputs:
    deploymentScope: 'Resource Group'
    azureResourceManagerConnection: 'Azure subscription 1 ($(subscriptionId))'
    subscriptionId: $(subscriptionId)
    action: 'Create Or Update Resource Group'
    resourceGroupName: $(resourceGroupName)
    location: 'East US 2'
    templateLocation: 'Linked artifact'
    csmFile: '$(Build.SourcesDirectory)/arm_templates/airflow/airflow_infra_template.json'
    csmParametersFile: '$(Build.SourcesDirectory)/arm_templates/airflow/airflow_infra_parameters.json'
    deploymentMode: 'Incremental'

- task: AzureResourceManagerTemplateDeployment@3
  displayName: 'Deploy VNet Peering between Airbyte and Kafka'
  inputs:
    deploymentScope: 'Resource Group'
    azureResourceManagerConnection: 'Azure subscription 1 ($(subscriptionId))'
    subscriptionId: $(subscriptionId)
    action: 'Create Or Update Resource Group'
    resourceGroupName: $(resourceGroupName)
    location: 'East US 2'
    templateLocation: 'Linked artifact'
    csmFile: '$(Build.SourcesDirectory)/arm_templates/vnet_peerings/vnet_peering_template.json'
    csmParametersFile: '$(Build.SourcesDirectory)/arm_templates/vnet_peerings/airbyte_kafka_vnet_peering_parameters.json'
    deploymentMode: 'Incremental'

- task: AzureResourceManagerTemplateDeployment@3
  displayName: 'Deploy VNet Peering between Kafka and Airflow'
  inputs:
    deploymentScope: 'Resource Group'
    azureResourceManagerConnection: 'Azure subscription 1 ($(subscriptionId))'
    subscriptionId: $(subscriptionId)
    action: 'Create Or Update Resource Group'
    resourceGroupName: $(resourceGroupName)
    location: 'East US 2'
    templateLocation: 'Linked artifact'
    csmFile: '$(Build.SourcesDirectory)/arm_templates/vnet_peerings/vnet_peering_template.json'
    csmParametersFile: '$(Build.SourcesDirectory)/arm_templates/vnet_peerings/kafka_airflow_vnet_peering_parameters.json'
    deploymentMode: 'Incremental'

- task: AzureResourceManagerTemplateDeployment@3
  displayName: 'Deploy VNet Peering between Airflow and MLflow'
  inputs:
    deploymentScope: 'Resource Group'
    azureResourceManagerConnection: 'Azure subscription 1 ($(subscriptionId))'
    subscriptionId: $(subscriptionId)
    action: 'Create Or Update Resource Group'
    resourceGroupName: $(resourceGroupName)
    location: 'East US 2'
    templateLocation: 'Linked artifact'
    csmFile: '$(Build.SourcesDirectory)/arm_templates/vnet_peerings/vnet_peering_template.json'
    csmParametersFile: '$(Build.SourcesDirectory)/arm_templates/vnet_peerings/airflow_mlflow_vnet_peering_parameters.json'
    deploymentMode: 'Incremental'

- task: AzureResourceManagerTemplateDeployment@3
  displayName: 'Deploy Private Endpoint from Airflow to Azure Blob Storage'
  inputs:
    deploymentScope: 'Resource Group'
    azureResourceManagerConnection: 'Azure subscription 1 ($(subscriptionId))'
    subscriptionId: $(subscriptionId)
    action: 'Create Or Update Resource Group'
    resourceGroupName: $(resourceGroupName)
    location: 'East US 2'
    templateLocation: 'Linked artifact'
    csmFile: '$(Build.SourcesDirectory)/arm_templates/airflow/airflow_storage_private_endpoint_template.json'
    csmParametersFile: '$(Build.SourcesDirectory)/arm_templates/airflow/airflow_storage_private_endpoint_parameters.json'
    deploymentMode: 'Incremental'

- task: AzureResourceManagerTemplateDeployment@3
  displayName: 'Deploy Private Endpoint from Airflow to Azure Blob Storage'
  inputs:
    deploymentScope: 'Resource Group'
    azureResourceManagerConnection: 'Azure subscription 1 ($(subscriptionId))'
    subscriptionId: $(subscriptionId)
    action: 'Create Or Update Resource Group'
    resourceGroupName: $(resourceGroupName)
    location: 'East US 2'
    templateLocation: 'Linked artifact'
    csmFile: '$(Build.SourcesDirectory)/arm_templates/airflow/airflow_mlstudio_private_endpoint_template.json'
    csmParametersFile: '$(Build.SourcesDirectory)/arm_templates/airflow/airflow_mlstudio_private_endpoint_parameters.json'
    deploymentMode: 'Incremental'
